<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Student Dashboard - Attendance System</title>
    <link rel="stylesheet" href="styles.css" />

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>


  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ‘¨â€ğŸ“ Student Dashboard</h1>
        <div class="user-info">
          <span id="userEmail"></span>
          <button onclick="logout()" class="logout-btn">Logout</button>
        </div>
      </div>

      <div class="face-enrollment-section">
        <h2>Face Enrollment</h2>
        <div class="row">
          <div class="col">
            <div class="camera-container">
              <video id="video" autoplay muted playsinline></video>
              <canvas id="canvas" style="display: none;"></canvas>
            </div>
            <div class="camera-controls">
              <button id="startCameraBtn" onclick="startCamera()" class="primary-btn">
                ğŸ“¹ Start Camera
              </button>
              <button id="enrollBtn" onclick="enrollFace()" class="secondary-btn" disabled>
                ğŸ“¸ Enroll Face
              </button>
            </div>
          </div>
          <div class="col">
            <div class="enrollment-info">
              <h3>Enrollment Status</h3>
              <p id="enrollmentStatus">Not enrolled. Start camera and enroll your face.</p>
            </div>
          </div>
        </div>
      </div>

      <div class="attendance-section">
        <h2>My Attendance</h2>
        <div class="attendance-log">
          <h3>Recent Attendance Records</h3>
          <div id="attendanceList" class="attendance-list">
            <p class="no-data">No attendance records found</p>
          </div>
        </div>
      </div>

      <div class="stats">
        <h2>My Statistics</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <h3 id="totalSessions">0</h3>
            <p>Total Sessions Attended</p>
          </div>
          <div class="stat-card">
            <h3 id="attendanceRate">0%</h3>
            <p>Overall Attendance Rate</p>
          </div>
        </div>
      </div>

      <div class="tools-section">
        <h2>Study Tools</h2>
        <div class="tools-grid">
          <div class="tool-card">
            <h3>ğŸ“„ PDF Study Assistant</h3>
            <p>Summarize PDFs, generate flashcards, quizzes, and ask voice-enabled questions</p>
            <button onclick="openStudyAssistant()" class="tool-btn">Open Study Assistant</button>
          </div>
          <div class="tool-card">
            <h3>ğŸ… Timetable Generator</h3>
            <p>Create optimized study schedules</p>
            <button onclick="openTimetable()" class="tool-btn">Generate Timetable</button>
          </div>
        </div>
      </div>

      <div class="chapters-section">
        <div class="tool-card" onclick="openChapters()">
          <h3>ğŸ“š Chapters</h3>
          <p>Access chapter materials and resources</p>
          <button class="tool-btn">View Chapters</button>
        </div>
      </div>





      <div class="calculator-section">
        <h2>Attendance Calculator</h2>
        <div class="calculator">
          <label for="totalClasses">Total Classes:</label>
          <input type="number" id="totalClasses" placeholder="e.g. 100" />
          <label for="attendedClasses">Classes Attended:</label>
          <input type="number" id="attendedClasses" placeholder="e.g. 85" />
          <button onclick="calculateAttendance()" class="primary-btn">Calculate</button>
          <div id="calcResult" class="calc-result"></div>
        </div>
      </div>
    </div>

    <div id="notification" class="notification hidden">
      <span id="notificationText"></span>
    </div>

    <script>
      // Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyBI9FWOhqfS6e1aHpC_guvx1r_zy14cobk",
        authDomain: "attendance-system-a1ac4.firebaseapp.com",
        projectId: "attendance-system-a1ac4",
        storageBucket: "attendance-system-a1ac4.firebasestorage.app",
        messagingSenderId: "462766302633",
        appId: "1:462766302633:web:b45441d758dc007c4250b8",
        measurementId: "G-2MMSHHN4CK"
      };

      // Initialize Firebase
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      let websocket = null;

      // Check authentication
      auth.onAuthStateChanged(user => {
        if (!user) {
          window.location.href = "login.html";
          return;
        }

        const role = localStorage.getItem("role");
        if (role !== "student") {
          alert("Access denied. Student role required.");
          window.location.href = "login.html";
          return;
        }

        document.getElementById("userEmail").textContent = user.email;
        connectWebSocket(user.uid);
        loadAttendance();
      });

      function connectWebSocket(userId) {
        websocket = new WebSocket(`ws://localhost:8000/ws/${userId}`);

        websocket.onopen = () => {
          console.log('Connected to notification server');
        };

        websocket.onmessage = (event) => {
          const data = JSON.parse(event.data);
          if (data.type === 'notification') {
            showNotification(data.message, 'success');
            // Reload attendance to show new record
            loadAttendance();
          }
        };

        websocket.onclose = () => {
          console.log('Disconnected from notification server');
          // Attempt to reconnect after 5 seconds
          setTimeout(() => connectWebSocket(userId), 5000);
        };

        websocket.onerror = (error) => {
          console.error('WebSocket error:', error);
        };
      }

      async function loadAttendance() {
        try {
          const user = auth.currentUser;
          if (!user) return;

          const studentId = user.uid;

          const response = await fetch(`http://localhost:8000/face/attendance?user_id=${studentId}`);
          if (!response.ok) {
            throw new Error('Failed to fetch attendance');
          }
          const attendanceData = await response.json();

          const attendanceList = document.getElementById('attendanceList');
          const noData = attendanceList.querySelector('.no-data');

          // Clear existing items
          attendanceList.innerHTML = '';

          if (attendanceData.length > 0) {
            if (noData) noData.remove();

            attendanceData.forEach(record => {
              const attendanceItem = document.createElement('div');
              attendanceItem.className = 'attendance-item';
              attendanceItem.innerHTML = `
                <div class="student-info">
                  <strong>Session: ${record.session_code}</strong>
                  <span class="timestamp">${new Date(record.marked_at).toLocaleString()}</span>
                </div>
                <span class="status present">Present</span>
              `;
              attendanceList.appendChild(attendanceItem);
            });

            // Update stats
            const totalSessions = attendanceData.length;
            document.getElementById('totalSessions').textContent = totalSessions;
            document.getElementById('attendanceRate').textContent = '100%'; // Placeholder, can be calculated if total sessions available
          } else {
            attendanceList.innerHTML = '<p class="no-data">No attendance records found</p>';
            document.getElementById('totalSessions').textContent = '0';
            document.getElementById('attendanceRate').textContent = '0%';
          }
        } catch (error) {
          console.error("Error loading attendance:", error);
          showNotification("Error loading attendance", "error");
        }
      }

      function showNotification(message, type = 'info') {
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notificationText');

        notificationText.textContent = message;
        notification.className = `notification ${type}`;
        notification.classList.remove('hidden');

        setTimeout(() => {
          notification.classList.add('hidden');
        }, 3000);
      }

      function logout() {
        auth.signOut().then(() => {
          localStorage.clear();
          window.location.href = "login.html";
        });
      }

      function openStudyAssistant() {
        window.open('http://localhost:8501', '_blank');
      }

      function openTimetable() {
        window.open('http://localhost:8000/code/time.py', '_blank');
      }

      function openChapters() {
        window.location.href = 'chapters.html';
      }

      async function startCamera() {
        try {
          const video = document.getElementById('video');
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { width: 640, height: 480, facingMode: 'user' }
          });
          video.srcObject = stream;
          document.getElementById("startCameraBtn").disabled = true;
          document.getElementById("enrollBtn").disabled = false;
          showNotification("Camera started successfully", "success");
        } catch (error) {
          console.error("Error starting camera:", error);
          showNotification("Error starting camera. Please allow camera access.", "error");
        }
      }

      async function enrollFace() {
        try {
          const video = document.getElementById('video');
          const canvas = document.getElementById('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0);

          canvas.toBlob(async (blob) => {
            const formData = new FormData();
            formData.append('user_id', auth.currentUser.uid);
            formData.append('file', blob, 'face.jpg');

            const response = await fetch('http://localhost:8000/face/enroll', {
              method: 'POST',
              body: formData
            });

            if (!response.ok) {
              const error = await response.json();
              throw new Error(error.detail || 'Failed to enroll face');
            }

            const result = await response.json();
            document.getElementById('enrollmentStatus').textContent = `Enrolled successfully. Total embeddings: ${result['total embeddings']}`;
            showNotification("Face enrolled successfully", "success");
          }, 'image/jpeg', 0.9);
        } catch (error) {
          console.error("Error enrolling face:", error);
          showNotification("Error enrolling face: " + error.message, "error");
        }
      }

      function calculateAttendance() {
        const total = parseInt(document.getElementById('totalClasses').value);
        const attended = parseInt(document.getElementById('attendedClasses').value);
        if (isNaN(total) || isNaN(attended)) {
          document.getElementById('calcResult').textContent = 'Please enter valid numbers';
          return;
        }
        const rate = ((attended / total) * 100).toFixed(2);
        document.getElementById('calcResult').textContent = `Attendance Rate: ${rate}%`;
      }

      async function loadChapters() {
        try {
          const response = await fetch('http://localhost:8000/curriculum/chapters');
          if (!response.ok) {
            throw new Error('Failed to fetch chapters');
          }
          const chapters = await response.json();

          const chaptersList = document.getElementById('chaptersList');
          chaptersList.innerHTML = '';

          if (chapters.length > 0) {
            chapters.forEach(chapter => {
              const chapterItem = document.createElement('div');
              chapterItem.className = 'tool-card';
              chapterItem.innerHTML = `
                <h3>ğŸ“š ${chapter.name}</h3>
                <p>Access chapter materials and resources</p>
                <div class="chapter-actions">
                  <button onclick="downloadPDF(${chapter.id})" class="tool-btn">ğŸ“¥ Download PDF</button>
                  <button onclick="getResources(${chapter.id})" class="tool-btn">ğŸ“š Get Resources</button>
                </div>
                <div id="resources-${chapter.id}" class="resources-display" style="display: none;"></div>
              `;
              chaptersList.appendChild(chapterItem);
            });
          } else {
            chaptersList.innerHTML = '<p class="no-data">No chapters available</p>';
          }
        } catch (error) {
          console.error("Error loading chapters:", error);
          showNotification("Error loading chapters", "error");
        }
      }

      function downloadPDF(chapterId) {
        window.open(`http://localhost:8000/curriculum/chapter/${chapterId}/pdf`, '_blank');
      }

      async function getResources(chapterId) {
        const resourcesDiv = document.getElementById(`resources-${chapterId}`);
        if (resourcesDiv.style.display === 'block') {
          resourcesDiv.style.display = 'none';
          return;
        }

        try {
          const response = await fetch(`http://localhost:8000/curriculum/chapter/${chapterId}/resources`);
          if (!response.ok) {
            throw new Error('Failed to fetch resources');
          }
          const data = await response.json();
          resourcesDiv.textContent = data.resources;
          resourcesDiv.style.display = 'block';
        } catch (error) {
          console.error("Error fetching resources:", error);
          showNotification("Error fetching resources", "error");
        }
      }

      // Load chapters on page load
      auth.onAuthStateChanged(user => {
        if (user && localStorage.getItem("role") === "student") {
          loadChapters();
        }
      });
    </script>
  </body>
</html>
